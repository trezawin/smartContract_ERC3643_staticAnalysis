# ERC-3643 Static + Compliance Analyzer

A research toolkit to evaluate **ERC-3643 (T-REX)** smart contracts in two phases:

- **Phase 1 – Static Security Analysis (Slither):** catch reentrancy, unchecked calls, loop issues, pragma mismatches, etc.
- **Phase 2 – Compliance Rule Engine (Hardhat + ABI checks):** verify ERC-3643 wiring and HKMA/SFC-inspired compliance surfaces via address-level rules.

‼️ Research prototype; not production-grade auditing.‼️

---

## Tested Environment (pin these to avoid dependency hell)

- **Node.js**: 22.x (tested with 22.19.0)
- **npm**: 9.x
- **Python**: 3.11+ (for Slither)
- **Hardhat**: 2.26.3 (CJS toolchain)
- **ethers**: 5.7.2
- **@nomiclabs/hardhat-ethers**: 2.2.3 (Hardhat v2 + ethers v5)
- **Solidity**: 0.8.17 (matches T-REX)
- **OpenZeppelin (Upgradeable)**: 4.9.6

---

## 1) One-time Project Setup

From the repo root:

```bash
# Clone and enter the project
git clone <YOUR-REPO-URL>
cd <YOUR-REPO-DIR>

# Install Node dependencies (Hardhat toolchain + T-REX stack)
npm install

# Optional: Python virtualenv for Slither (Phase 1)
python3 -m venv erc_venv
source erc_venv/bin/activate
pip install --upgrade pip
pip install slither-analyzer crytic-compile
```

The repository already pins Hardhat (2.26.3), ethers v5, and the T-REX contracts in `package.json`, so a plain `npm install` is sufficient unless you are adjusting versions manually.

---

## Run Phase 1 (Static Analysis)

```bash
# Compile contracts through Hardhat
npm run build

# Execute Slither through the TS harness; writes JSON + SARIF under reports/
npm run phase1:slither

# Generate Markdown / CSV human summaries
npm run phase1:summary
```

Outputs:
- `reports/slither.json` – raw Slither findings
- `reports/slither.sarif` – CI-friendly SARIF
- `reports/phase1-summary.md` – human summary (top issues, severities)
- `reports/phase1-findings.csv` – spreadsheet of findings

---

## Run Phase 2 (Compliance Wiring)

```bash
# Deploy a local T-REX stack and write `.cre.addresses.json`
npm run phase2:bootstrap

# Evaluate baseline compliance rules -> `reports/phase2-results.json`
npm run phase2:run

# Render / open the HTML report
npm run phase2:render
npm run phase2:open    # macOS `open` (skip on headless CI)

# Convenience shortcut for all four steps
npm run p2
```

Baseline rules live in `cre/rules/baseline.json`. Adjust or extend them as needed for jurisdiction-specific checks.

---

## Typical workflow

```bash
# 1) Build
npm run build

# 2) Phase 1 (security)
npm run phase1:slither
npm run phase1:summary

# 3) Phase 2 (compliance wiring checks)
npm run phase2:bootstrap      # or edit .cre.addresses.json with production addresses
npm run phase2:run
npm run phase2:render && npm run phase2:open
```

---

## Folder map (quick reference)

- `scripts/` – TypeScript/JavaScript harness for Slither, reporting, and compliance checks.
- `cre/` – rule definitions consumed by the phase-2 engine.
- `reports/` – outputs generated by Phase 1 and Phase 2 workflows.
- `artifacts/` / `cache/` / `typechain-types/` – Hardhat build outputs.
- Contract sources come from `@tokenysolutions/t-rex` and related packages in `node_modules`; the project no longer ships local Solidity copies.

---

## Caveats

- Hardhat network is ephemeral; re-run `npm run phase2:bootstrap` whenever you restart your dev node or want fresh addresses.
- Phase 2 defaults to local JSON-RPC (`http://127.0.0.1:8545`). Override `networkRpc` inside `.cre.addresses.json` to target a live environment.
- Slither runs through `scripts/run-slither.ts` with default Hardhat compilation; adjust that harness if your environment requires extra filters or plugins.
